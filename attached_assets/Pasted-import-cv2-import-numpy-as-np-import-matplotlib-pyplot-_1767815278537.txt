import cv2
import numpy as np
import matplotlib.pyplot as plt
import matplotlib.patches as patches

def transformer_en_scanner(image_path, output_path):
    """
    Transforme la photo en image style 'scanner' (noir et blanc, contrastée).
    """
    # 1. Charger l'image
    img = cv2.imread(image_path)
    if img is None:
        print("Erreur: Image non trouvée.")
        return

    # 2. Rotation de 90 degrés (car l'image originale est couchée)
    img_rotated = cv2.rotate(img, cv2.ROTATE_90_COUNTERCLOCKWISE)

    # 3. Convertir en niveaux de gris
    gray = cv2.cvtColor(img_rotated, cv2.COLOR_BGR2GRAY)

    # 4. Appliquer un seuillage adaptatif pour enlever le quadrillage et garder l'écriture
    # Cela crée l'effet "Scanner"
    scanner_effect = cv2.adaptiveThreshold(
        gray, 255, cv2.ADAPTIVE_THRESH_GAUSSIAN_C, cv2.THRESH_BINARY, 31, 15
    )

    # Sauvegarder l'image scanner
    cv2.imwrite(output_path, scanner_effect)
    print(f"Image scanner sauvegardée sous : {output_path}")
    return scanner_effect

def generer_page_numerique():
    """
    Génère une page blanche avec le texte numérique et le schéma du Bec Bunsen.
    """
    # Création de la figure
    fig, ax = plt.subplots(figsize=(10, 14)) # Format A4 approximatif
    ax.set_xlim(0, 100)
    ax.set_ylim(0, 140)
    ax.axis('off') # Pas d'axes

    # --- PARTIE 1 : LE TEXTE ---
    
    # Titre
    ax.text(50, 135, "Combustion complète", fontsize=20, ha='center', fontweight='bold', color='green', style='italic')
    
    # Corps du texte
    y_cursor = 125
    line_spacing = 4
    
    content = [
        ("Observation :", "La flamme est bleue.", 'green'),
        ("Interprétation :", "La virole ouverte permet d'avoir une quantité suffisante\nde dioxygène provenant de l'air d'où la flamme est bleue.\nCette flamme bleue indique que la combustion est complète.", 'green'),
        ("Conclusion :", "La combustion complète se fait avec une flamme bleue.", 'green'),
        ("Note :", "Mise en évidence des produits de la combustion complète.\nExpérience.", 'red')
    ]

    for title, text, color in content:
        ax.text(5, y_cursor, title, fontsize=14, fontweight='bold', color=color)
        # Découpage du texte pour qu'il tienne en largeur
        ax.text(5, y_cursor - 2, text, fontsize=12, va='top', wrap=True)
        # Calcul approximatif de l'espace pris par le texte pour descendre le curseur
        lines = text.count('\n') + 1
        y_cursor -= (lines * 3) + 5

    # --- PARTIE 2 : LE SCHÉMA DU BEC BUNSEN ---
    
    # Coordonnées de base pour le dessin (en bas à droite)
    bx, by = 60, 40 
    
    # 1. Le Socle (Base)
    base = patches.Polygon([[bx-10, by], [bx+10, by], [bx+5, by+5], [bx-5, by+5]], 
                           closed=True, edgecolor='black', facecolor='lightgray')
    ax.add_patch(base)
    
    # 2. Le Tube (Cheminée)
    tube = patches.Rectangle((bx-2, by+5), 4, 30, linewidth=1, edgecolor='black', facecolor='white')
    ax.add_patch(tube)
    
    # 3. La Virole (ouverte - avec un petit rond pour symboliser l'ouverture)
    virole = patches.Rectangle((bx-3, by+10), 6, 8, linewidth=1, edgecolor='black', facecolor='#ddd')
    hole = patches.Circle((bx, by+14), 1.5, edgecolor='black', facecolor='white') # Le trou d'air
    ax.add_patch(virole)
    ax.add_patch(hole)
    
    # 4. La Flamme (Bleue)
    # Forme simple de flamme
    flame_pts = [[bx-2, by+35], [bx+2, by+35], [bx, by+55]]
    flame = patches.Polygon(flame_pts, closed=True, color='blue', alpha=0.6)
    # Ajouter un cœur de flamme plus clair
    flame_inner = patches.Polygon([[bx-1, by+35], [bx+1, by+35], [bx, by+45]], closed=True, color='cyan', alpha=0.8)
    
    ax.add_patch(flame)
    ax.add_patch(flame_inner)

    # --- PARTIE 3 : LES LÉGENDES (FLÉCHES) ---
    
    # Fonction utilitaire pour les flèches
    def draw_arrow(label, xy_target, xy_text):
        ax.annotate(label, xy=xy_target, xytext=xy_text,
                    arrowprops=dict(facecolor='black', arrowstyle='->'),
                    fontsize=10, color='darkblue')

    draw_arrow("Flamme bleue", (bx+1, by+45), (bx+20, by+45))
    draw_arrow("Virole ouverte", (bx+3, by+14), (bx+20, by+14))
    draw_arrow("Bec Bunsen", (bx-5, by+5), (bx-25, by+5))

    # Sauvegarde
    plt.savefig("page_numerique_finale.png", dpi=300, bbox_inches='tight')
    print("Page numérique (texte + schéma) générée : page_numerique_finale.png")
    plt.show()

# --- EXÉCUTION ---

# Remplacez 'votre_image.jpg' par le nom réel de votre fichier image
# Si vous n'avez pas l'image locale, commentez la ligne suivante
try:
    # Etape 1 : Créer l'effet scanner (Nécessite le fichier image original)
    # Assurez-vous d'avoir l'image dans le même dossier et changez le nom ci-dessous
    transformer_en_scanner('image_originale.jpg', 'image_scanner_sortie.jpg')
except Exception as e:
    print(f"L'étape scanner a été sautée (Image non trouvée ou erreur): {e}")

# Etape 2 : Créer la nouvelle page propre
generer_page_numerique()